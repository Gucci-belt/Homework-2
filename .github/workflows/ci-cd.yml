name: CI-CD Pipeline (Greeting API)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-test-and-push:
    runs-on: ubuntu-latest
    steps:
      
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # --- ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ---
      # ‡πÄ‡∏£‡∏≤‡∏°‡∏µ "‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö" ‡πÅ‡∏Ñ‡πà‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
      # ‡∏°‡∏±‡∏ô‡∏à‡∏∞ "‡∏û‡∏±‡∏á" üî¥ ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ú‡πà‡∏≤‡∏ô" üü¢ ‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ß‡πà‡∏≤ app.py ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤ push ‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÑ‡∏´‡∏ô
      - name: 3. (Validation) Run Unit Tests
        run: python -m unittest test_app.py # <-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏î‡∏™‡∏≠‡∏ö
        
      # --- ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4-8 ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô "‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠" ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3 ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ---

      - name: 4. Generate Build Number
        id: build_number
        run: echo "VERSION_NUMBER=1.0.$(git rev-list --count HEAD)" >> $GITHUB_OUTPUT
        
      - name: 5. Log in to Docker Hub
        # ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏™‡∏ú‡πà‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£ push ‡∏Ç‡∏∂‡πâ‡∏ô main ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 6. Build and Push Docker Image
        # ‡πÄ‡∏£‡∏≤‡∏à‡∏∞ Build & Push ‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏™‡∏ú‡πà‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£ push ‡∏Ç‡∏∂‡πâ‡∏ô main ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            gbelt/homework-2:${{ steps.build_number.outputs.VERSION_NUMBER }}
